# ТЗ: Изменить расчет стоимости сетапа для заказа через `InstallerQualification`

---

## Цель

Полностью переработать логику расчета стоимости сетапа заказа с учетом:

- минимальной стоимости работы одного сетапера;
- почасовой ставки сетапера;
- количества требуемых сетаперов по товарам;
- требуемых квалификаций (`InstallerQualification`).

Старая логика расчета стоимости сетапа через `InstallerQualification` должна быть полностью заменена новой.

---

## Новые поля

Добавить два новых числовых поля (в рублях) для сущности, описывающей сетапера или его квалификацию (в зависимости от текущей модели данных):

- `minimal_price_rub` — минимальная стоимость работы одного сетапера за заказ;
- `hour_price_rub` — почасовая стоимость работы одного сетапера.

---

## Входные данные для расчета

Для расчета стоимости сетапа по заказу считаем, что доступны следующие данные:

- Список товаров в заказе.
- Для каждого товара:
  - количество единиц товара в заказе;
  - длительность сетапа (в минутах) для **одной** единицы товара;
  - требования по сетаперам:
    - общее количество сетаперов, необходимых для установки данного товара;
    - для части или всех сетаперов — требуемый `InstallerQualification`, который может быть:
      - конкретная квалификация, например: `"Сотрудник с парогенератором"`;
      - специальное значение `"Любой"` — означает, что квалификация не важна.

---

## Общая схема расчета

1. Посчитать общее время сетапа по заказу (в часах).
2. Определить необходимое количество сетаперов и их квалификации для всего заказа.
3. Для каждого требуемого типа сетапера (по квалификации) посчитать стоимость с учетом:
   - почасовой ставки (`hour_price_rub`);
   - минимальной стоимости (`minimal_price_rub`);
   - общего количества часов сетапа.
4. Сложить стоимости по всем требуемым сетаперам.

---

## 1. Расчет общего времени сетапа (`total_setup_hours`)

1. Для каждого товара в заказе:
   - взять длительность сетапа одной единицы товара (в минутах);
   - умножить на количество единиц этого товара в заказе.
2. Сложить длительности по всем товарам.
3. Полученное итоговое значение в минутах перевести в часы (на бэке, по принятому в системе правилу округления).

Результат:  
`total_setup_hours` — общее количество часов сетапа для заказа.

> В этом ТЗ способ округления (в большую/меньшую сторону, до целого, до десятых и т.п.) не фиксируется и может использоваться текущий системный.

---

## 2. Определение количества сетаперов и их квалификаций

Задача: определить, **сколько** сетаперов и **каких квалификаций** нужно для всего заказа.

### 2.1. Максимальное количество сетаперов

1. Пройти по всем товарам в заказе.
2. Для каждого товара взять его «общее количество сетаперов».
3. Найти максимум:

```text
max_installers_count = максимум(общее количество сетаперов по всем товарам)
```

Это число задает минимальное общее количество сетаперов, которое нужно учитывать при расчете стоимости для всего заказа.

### 2.2. Квалификации, отличные от `"Любой"`

1. Пройти по требованиям по сетаперам для всех товаров.
2. Собрать все требования к `InstallerQualification`, отличные от `"Любой"`.
3. Для каждой такой квалификации определить, сколько сетаперов с ней нужно в рамках всего заказа (общее требуемое количество по заказу).

В результате должен быть определен:

- набор конкретных квалификаций (не `"Любой"`) и требуемое количество сетаперов для каждой;
- общее количество сетаперов `max_installers_count`, которое не может быть меньше суммы всех конкретных квалификаций.

### 2.3. Итоговое распределение сетаперов

- Общее количество сетаперов для заказа = `max_installers_count`.
- Среди этих `max_installers_count`:
  - часть слотов занята сетаперами с конкретными `InstallerQualification` (не `"Любой"`);
  - оставшиеся слоты занимают сетаперы с квалификацией `"Любой"`.

Важно:

- Если среди товаров есть товары с конкретными квалификациями, все такие квалификации должны быть представлены в итоговом наборе сетаперов.
- При этом общее количество сетаперов должно составлять `max_installers_count` (не меньше).

---

## 3. Расчет стоимости для каждого типа сетапера

Для каждого типа сетапера (по квалификации) расчет выполняется отдельно.  
Типы:

- конкретная квалификация (например, `"Сотрудник с парогенератором"`);
- квалификация `"Любой"`.

Для каждого типа:

1. Получить значения:
   - `minimal_price_rub` — минимальная стоимость работы одного сетапера данного типа за заказ;
   - `hour_price_rub` — почасовая стоимость одного сетапера данного типа;
   - `total_setup_hours` — общее количество часов сетапа по заказу.
2. Рассчитать стоимость по часам:

```text
calculated_price = hour_price_rub * total_setup_hours
```

3. Сравнить с минимальной стоимостью:

```text
if calculated_price < minimal_price_rub:
    price_for_one_installer = minimal_price_rub
else:
    price_for_one_installer = calculated_price
```

4. Умножить стоимость одного сетапера данного типа на количество сетаперов с этой квалификацией:

```text
total_price_for_qualification = price_for_one_installer * количество_сетаперов_данной_квалификации
```

5. Итоговая стоимость сетапа по заказу:

```text
total_setup_price = сумма(total_price_for_qualification по всем квалификациям)
```

---

## 4. Особая логика по количеству и типам сетаперов

Ключевые моменты:

- Необходимое количество сетаперов для заказа определяется как:
  - `max_installers_count` — максимальное общее количество сетаперов, требуемое любым товаром.
- Если среди товаров встречаются товары, требующие **конкретную** квалификацию:
  - такие квалификации должны обязательно присутствовать в итоговом наборе сетаперов;
  - количество сетаперов этих квалификаций должно удовлетворять требованиям товаров (минимум по всем товарам);
  - оставшиеся до `max_installers_count` слоты заполняются сетаперами с квалификацией `"Любой"`.

---

## 5. Пример

### Исходные данные

Есть два товара:

1. **Товар A**
   - Требуемая квалификация: `"Сотрудник с парогенератором"`;
   - Общее количество сетаперов для установки: `3`.

2. **Товар B**
   - Требуемая квалификация: `"Любой"`;
   - Общее количество сетаперов для установки: `4`.

### Определение количества сетаперов

1. Максимальное количество сетаперов среди товаров:

```text
max_installers_count = max(3, 4) = 4
```

2. Среди товаров есть товар с конкретной квалификацией:
   - `"Сотрудник с парогенератором"` — он должен быть обязательно представлен в итоговом наборе сетаперов.

3. Итоговый набор сетаперов для заказа:

- 1 сетапер с квалификацией `"Сотрудник с парогенератором"`;
- 3 сетапера с квалификацией `"Любой"`;
- всего 4 сетапера (совпадает с `max_installers_count`).

> Важно: логика сводится к тому, что мы:
> - берем максимальное количество сетаперов (4),
> - удовлетворяем требование по наличию конкретной квалификации,
> - оставшиеся слоты заполняем `"Любой"`.

### Расчет стоимости

Пусть:

- Для квалификации `"Сотрудник с парогенератором"` заданы:
  - `minimal_price_rub_steam`;
  - `hour_price_rub_steam`.
- Для квалификации `"Любой"` заданы:
  - `minimal_price_rub_any`;
  - `hour_price_rub_any`.

1. Считаем `total_setup_hours` по всем товарам (см. раздел 1).
2. Рассчитываем стоимость:

Для 1 сетапера `"Сотрудник с парогенератором"`:

```text
calculated_price_steam = hour_price_rub_steam * total_setup_hours

price_for_one_steam =
    minimal_price_rub_steam, если calculated_price_steam < minimal_price_rub_steam
    иначе calculated_price_steam

total_price_steam = price_for_one_steam * 1
```

Для 3 сетаперов `"Любой"`:

```text
calculated_price_any = hour_price_rub_any * total_setup_hours

price_for_one_any =
    minimal_price_rub_any, если calculated_price_any < minimal_price_rub_any
    иначе calculated_price_any

total_price_any = price_for_one_any * 3
```

Итоговая стоимость сетапа заказа:

```text
total_setup_price = total_price_steam + total_price_any
```

---

Так-же данную процедуру нужно повторить и для стоимости демонтажа, с единственным изменением в том, что мы берем 'Демонтаж, минут' из товаров

## Изменения в staff

в подробной информации о заказе на странице /orders/{id} нужно разделить стоимость доставки, монтажа и демонтажа на 3 отдельных поля, как в модели на бэке так и в React приложении staff

