# Логистика: новый раздел с подтабами «Подготовка заказа» и «Приёмка»

**Цель:** Добавить в staff React‑приложение новый пункт бокового меню «Логистика» с двумя подразделами — «Подготовка заказа» и «Приёмка», а также расширить модель `Order` и API/интерфейсы для работы со статусами оплаты, состояниями заказа и приёмкой на склад.

---

## Область работ

### 1) Навигация / Роутинг (staff)
- Добавить новый пункт бокового меню: **Логистика**.
- Подменю:
  - **Подготовка заказа** — `route: /logistics/prep`
  - **Приёмка** — `route: /logistics/receiving`
- Реализацию подстраниц и карточек заказов **повторить/переиспользовать** из текущей страницы **orders** (список, карточка заказа, список товаров, отображение картинок).

### 2) Модель и база данных (backend)
Добавить статусы оплаты и состояния заказа.

#### 2.1 Статус оплаты
В `Order` добавить поле `payment_status` со значениями через choices:
- `paid` — «оплачен»
- `unpaid` — «не оплачен»
- `partially_paid` — «частично оплачен»

**Миграция:**
- Новое поле `payment_status` (ENUM/строка с ограничениями).
- Значение по умолчанию для существующих записей: `unpaid` (если не указано иное в старых данных).
- Индекс по `payment_status` (для фильтрации).

#### 2.2 Состояние заказа (этапы логистики)
В `Order` добавить поле `logistics_state` (nullable) со значениями:
- `handover_to_picking` — «Передан на сборку»
- `picked` — «Собран»
- `shipped` — «Отгружен»
- `null` — состояние не задано

**Миграция:**
- Новое поле `logistics_state` (ENUM/строка, nullable).
- Индекс по `logistics_state`.

#### 2.3 Приёмка на склад
Ввести фиксацию факта приёмки:
- `warehouse_received_at` (nullable `datetime`)
- `warehouse_received_by` (nullable `user_id`/`staff_id`)
- Булевое пedредставление статуса приёмки: считается «Принят на склад», если `warehouse_receiv_at` не `null`.

**Миграция:**
- Поля `warehouse_received_at`, `warehouse_received_by`.
- Композитный индекс `(logistics_state, warehouse_received_at)`.

#### 2.4 Дата отгрузки
Используем существующее поле `shipment_date` (или добавить, если отсутствует):
- Тип: `date` или `datetime` (для группировки по датам).
- Индекс по `shipment_date`.

### 3) API (backend)
Расширить/добавить эндпоинты:

- `GET /api/orders`
  - Параметры фильтрации (все необязательны):
    - `payment_status` ∈ {`paid`, `unpaid`, `partially_paid`} (мультивыбор)
    - `logistics_state` ∈ {`handover_to_picking`, `picked`, `shipped`, `null`} (мультивыбор)
    - `shipment_date_from`, `shipment_date_to` (ISO даты)
    - `q` — поиск по номеру заказа (частичное совпадение)
  - Пагинация, сортировка по `shipment_date` (desc по умолчанию).
  - Включать:
    - Основные поля заказа: id/номер, адрес/самовывоз, `payment_status`, `logistics_state`, `shipment_date`, комментарий.
    - Состав заказа (позиции с названием товара, количеством, ссылкой на изображение).

- `PATCH /api/orders/:id/payment-status`
  - Body: `{ payment_status: 'paid' | 'unpaid' | 'partially_paid' }`

- `PATCH /api/orders/:id/logistics-state`
  - Body: `{ logistics_state: 'handover_to_picking' | 'picked' | 'shipped' | null }`

- `POST /api/orders/:id/receive`
  - Фиксация приёмки на склад.
  - Body: `{ received: true }` (или пустое body), на бэке выставляются `warehouse_received_at=now`, `warehouse_received_by=current_user`.
  - Идемпотентность: повторный вызов не должен менять данные (если уже принято).

> **Примечание:** при создании заказа через существующий эндпоинт создать возможность задавать `payment_status` (см. 4.2).

### 4) Интерфейс (staff)

#### 4.1 Подготовка заказа (`/logistics/prep`)
- **Группировка по датам отгрузки** (`shipment_date`) — секции «Сегодня», «Завтра», «…», или группировка по конкретным датам (YYYY‑MM‑DD) в порядке убывания.
- **Элемент (карточка) заказа** содержит:
  - Номер заказа (кликабелен при наличии деталки).
  - Тип доставки: **Адрес** или **Самовывоз**.
  - **Статус оплаты** (badge): «оплачен»/«не оплачен»/«частично оплачен».
  - **Кнопки состояний** (тогглы, по аналогии с радиокнопками):
    - «Передан на сборку»
    - «Собран»
    - «Отгружен»
    - По умолчанию ни одна кнопка не подсвечена (если `logistics_state=null`). При клике выставляется соответствующее значение и активная кнопка подсвечивается. Допускается смена состояния на любое из трёх. (Опционально — повторный клик по активной кнопке может сбрасывать состояние в `null`.)
  - Комментарий к заказу (под заголовком).
  - **Состав заказа**: список позиций с названием товара, количеством и миниатюрой изображения.
- **Фильтры и поиск** (панель сверху):
  - По статусу оплаты (мультивыбор).
  - По состоянию логистики (мультивыбор, включая «без состояния»).
  - По дням/датам отгрузки (date/date‑range picker; пресеты «Сегодня», «Завтра», «Неделя»).
  - По номеру заказа (поиск с debounce).
- Пагинация/ленивая подгрузка, пустые состояния, лоадеры, обработка ошибок.

#### 4.2 Страница создания/редактирования заказа (orders)
- В форму **создания заказа** добавить селект «Статус оплаты» с тремя значениями (обязательное поле).
- В форму **редактирования** — возможность менять `payment_status`.
- Валидация и отображение ошибок API.

#### 4.3 Приёмка (`/logistics/receiving`)
- Отображаются **только заказы с `logistics_state=shipped`** и **не принятые на склад** (`warehouse_received_at is null`).
- Макет карточек **как в «Подготовка заказа»**, но:
  - **без кнопок состояний**,
  - **без статуса оплаты**.
- Кнопка **«Принят на склад»** на карточке:
  - По нажатию вызывает `POST /api/orders/:id/receive`.
  - После успеха — карточка исчезает из списка (либо появляется бейдж «Принят» до перезагрузки).

### 5) Доступы и аудит
- Все изменения статусных полей выполнять от имени текущего пользователя; сохранять `warehouse_received_by` на приёмке.
- Логи/аудит (при наличии): кто, когда изменил `payment_status`, `logistics_state`, выполнил приёмку.

### 6) i18n
Добавить ключи для русских меток:
- `payment_status.paid` → «оплачен»
- `payment_status.unpaid` → «не оплачен»
- `payment_status.partially_paid` → «частично оплачен»
- `logistics_state.handover_to_picking` → «Передан на сборку»
- `logistics_state.picked` → «Собран»
- `logistics_state.shipped` → «Отгружен»
- `logistics.receive` → «Принят на склад»
- Прочие UI‑строки для фильтров/поиска.

### 7) UX детали
- Кнопки состояний — взаимно исключающие, с чёткой подсветкой активного состояния.
- Badge статуса оплаты — цветовая дифференциация (напр., зелёный/красный/оранжевый).
- Группы по дате отгрузки — сворачиваемые секции.
- В фильтрах отображать счётчик выбранных опций, кнопку «Сбросить».
- Список должен поддерживать виртуализацию при больших объёмах (опционально).

### 8) Производительность
- Индексы БД: `payment_status`, `logistics_state`, `shipment_date`.
- N+1: в `GET /api/orders` возвращать товары батчом/join’ом.
- CDN/кеш для изображений товаров (если применимо).

### 9) Сценарии и критерии приёмки (AC)

**AC‑1: Навигация**
- В меню есть пункт «Логистика» с двумя вкладками «Подготовка заказа» и «Приёмка».

**AC‑2: Статусы оплаты**
- В форме создания заказа есть селект из трёх значений.
- Сохранённый заказ отображает правильный badge статуса.
- Фильтр по статусу оплаты корректно сужает выдачу.

**AC‑3: Состояния логистики**
- По умолчанию у заказа состояние `null`, кнопки не подсвечены.
- Клик по кнопке задаёт состояние и подсвечивает её.
- Переключение между состояниями работает, данные сохраняются.

**AC‑4: Группировка и отображение состава**
- Заказы сгруппированы по `installation_date` (по убыванию).
- На карточке видны номер, тип доставки, комментарий, состав (название, кол‑во, миниатюра).

**AC‑5: Фильтры/поиск**
- Фильтрация по датам, статусам оплаты, состояниям, поиск по номеру — работают совместно.
- Параметры фильтров отражаются в URL (опционально).

**AC‑6: Приёмка**
- Во вкладке «Приёмка» видны только `logistics_state=shipped` и не принятые заказы.
- Нажатие «Принят на склад» фиксирует приёмку и удаляет карточку из списка.

**AC‑7: API**
- Все описанные эндпоинты возвращают корректные данные и обрабатывают ошибки.
- Идемпотентность `POST /receive` подтверждена тестами.

### 11) Тестирование
- Unit‑тесты: конвертеры/редьюсеры UI, валидация форм, фильтрация.
- Интеграционные тесты API: фильтры, изменение статусов, приёмка.
- E2E (smoke): сценарии AC‑2..AC‑6.

### 12) Миграция и обратная совместимость
- Бэкенд: миграции для новых полей.
- Бэкап/план отката.
- Бекфилл `payment_status` для старых записей → `unpaid` (если поле было пустым).

### 13) Out of Scope
- Изменения в расчётах оплаты/эквайринге.
- Уведомления/веб‑хуки.
- Печать/экспорт документов.

---

## Технические заметки по реализации
- Переиспользовать существующие компоненты списка и карточки заказа со страницы `orders`.
- Типы/enum’ы хранить централизованно и шарить между формой заказа и логистикой.
- Обновления состояния делать оптимистично, с откатом при ошибке.
