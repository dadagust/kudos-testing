# ТЗ: режим «Аренда (Особый)» для продуктов — staff `/products`

> **Контекст.** На странице редактирования/создания продукта в staff есть поле **«Аренда»** с единственным вариантом **«Стандартный»**. Нужно добавить вариант **«Особый»** и логику дифференцированной стоимости по дням.

> **Ключевая мысль.** **1-й день** аренды всегда равен значению поля продукта **«Стоимость, ₽»**. Для **следующих дней** администратор может задать **до трёх** уровней (интервалов по дням) со своей ценой **за день**. Эти же правила применяются при **добавлении товара в Заказы** (страница оформления/создания заказа).

---

## Цели
1. Добавить в поле **«Аренда»** второй вариант — **«Особый»**.
2. При выборе **«Особый»** показать редактор уровней цен по дням (до 3 уровней).
3. Гарантировать корректный расчёт стоимости:
   - в карточке продукта (просчёт и валидации формы);
   - **при добавлении товара в Заказы** (расчёт строки заказа/калькуляция итогов).

---

## UI/UX

### Поле «Аренда»
- Тип: `Select`/`Radio`.
- Варианты:
  - **Стандартный**
  - **Особый**

### Когда выбран «Особый»
Показываем блок **«Тарифы по дням (до 3 уровней)»** — повторяющиеся строки (repeater):

Колонки уровня:
1) **До какого дня включительно** (`end_day`, целое ≥ 2)  
2) **Цена за день, ₽** (`price_per_day`, дробное число ≥ 0)

Управление:
- Кнопка **«Добавить уровень»** (до 3 строк всего).
- В каждой строке — **Удалить**.
- Подсказка рядом:  
  > 1-й день = «Стоимость, ₽».  
  > Уровни задают цену **за день** для дней после 1-го в указанных промежутках.

Валидации/UX:
- Нельзя добавить более **3** уровней.
- `end_day` — **строго по возрастанию** от строки к строке (например: 3, 7, 14).
- Минимальный `end_day` в первой строке — **2**.
- `price_per_day` ≥ 0.
- Поле `end_day` — **только целые числа** (маска).
- Поле `price_per_day` — **дробные числа** (маска).
- Порядок уровней фиксированный (автосортировка по `end_day`).
- *[Допущение]* Можно выводить предупреждение, если следующий уровень дороже предыдущего (не блокирующая валидация).
- При переключении **«Особый» → «Стандартный»** блок скрываем. *[Допущение]* Значения уровней храним в состоянии формы, но отправляем на бэкенд только если выбран «Особый».

---

## Модель данных (frontend payload)

```ts
type RentalMode = 'standard' | 'special';

type RentalTier = {
  end_day: number;        // до какого дня включительно действует уровень (>=2)
  price_per_day: number;  // цена за день в ₽
};

type ProductPayload = {
  // ...существующие поля
  price: number;               // «Стоимость, ₽» — базовая цена (дробное)
  rental_mode: RentalMode;     // 'standard' | 'special'
  rental_tiers?: RentalTier[]; // только при 'special'; максимум 3 элемента
};
```

Правила сериализации:
- `rental_mode: 'standard'` → `rental_tiers` **не отправляем** (или пустой массив).
- `rental_mode: 'special'` → `rental_tiers` — массив 1..3 элементов, **отсортирован по `end_day`**.

---

## Алгоритм расчёта

Обозначения:
- `D` — длительность аренды в днях (целое ≥ 1).
- `P1` — цена за **1-й день** = поле продукта **price** («Стоимость, ₽»).
- `tiers` — массив уровней `{end_day, price_per_day}`, отсортированный по возрастанию `end_day`.

### Стандартный
```
total = P1 * D
```

### Особый
```
total = P1                                         // день 1
      + Σ_{day=2..D} price_for(day)

где price_for(day):
  - Найти первый уровень t, для которого day <= t.end_day → t.price_per_day
  - Если таких уровней нет → last(tiers).price_per_day    // [Допущение] длинные аренды
```

*[Допущение]* Если D превышает максимальный `end_day`, используем цену **последнего уровня** для всех последующих дней.

---

## Примеры

### Пример 1
- `price` (1-й день): **3000 ₽**
- Уровни:
  - `end_day=3, price_per_day=2500`  → дни 2–3 по **2500 ₽/день**
  - `end_day=7, price_per_day=2200`  → дни 4–7 по **2200 ₽/день**
- `D = 1` → `total = 3000`
- `D = 3` → `3000 + 2500*2 = 8000`
- `D = 5` → `3000 + 2500*2 + 2200*2 = 11900`
- `D = 9` → `3000 + 2500*2 + 2200*5 + 2200*2 = 23400` (дни 8–9 по последнему уровню)

### Пример 2 (один уровень)
- `price`: **3500 ₽**
- Уровни: `end_day=2, price_per_day=3000`
- `D = 4` → `3500 + 3000*3 = 12500` (дни 2–4 по 3000 ₽)

---

## Интеграция с **Заказами**

### Требования
1. При **добавлении товара в Заказы** (создание/редактирование заказа) расчёт стоимости должен использовать ту же логику «Стандартный/Особый».
2. UI заказа должен позволять указать `D` (длительность в днях) для позиции. По умолчанию `D = 1`.
3. Для продуктов с `rental_mode='special'`:
   - 1-й день = `price`;
   - последующие дни — по уровням (`rental_tiers`) согласно алгоритму выше.
4. В карточке позиции заказа показывать:
   - `D`, применённые уровни и **итог по позиции** (`line_total`).
   - *[Опционально]* раскрываемую «разбивку по дням/интервалам» для прозрачности.
5. Сумма заказа (`order_total`) пересчитывается при изменении `D`, количества единиц товара и т.д.

### Данные позиции заказа (payload, *примерно*)
```ts
type OrderLinePayload = {
  product_id: string;
  quantity: number;      // кол-во единиц товара
  rental_days: number;   // D
  rental_mode: 'standard' | 'special';
  // можно слать снимок уровней для идемпотентности/аудита (опционально):
  rental_tiers?: RentalTier[];
  // итог по позиции на клиенте (для UX), бэкенд всё равно перепроверит:
  client_line_total?: number;
};
```

*[Рекомендация]* Бэкенд должен **валидационно** пересчитывать итог и игнорировать манипуляции клиента. На фронте расчёт — для мгновенной обратной связи.

---

## Валидации при сохранении (frontend)
- `rental_mode` обязателен.
- Для `special`:
  - Кол-во уровней: 1..3.
  - Массив строго возрастающий по `end_day`: `tiers[i].end_day < tiers[i+1].end_day`.
  - `tiers[0].end_day >= 2`.
  - `price_per_day >= 0`.
  - *Опционально:* предупреждение при «возрастающих» ценах между уровнями.

---

## Изменения в API (если потребуются)
- В составе продукта: `rental_mode`, `rental_tiers`.
- При чтении продукта с `standard` — `rental_tiers` может отсутствовать/быть пустым.
- При чтении продукта с `special` — уровни приходят отсортированными.

---

## Acceptance Criteria
1. В поле **«Аренда»** доступны варианты: **Стандартный**, **Особый**.
2. При **Особый** появляется блок уровней с лимитом **до 3** строк и соответствующими валидациями.
3. **1-й день** всегда равен **«Стоимость, ₽»** из карточки товара.
4. Уровни задают **цену за день** для дней **после первого** как интервалы по `end_day`.
5. Payload продукта соответствует спецификации.
6. Алгоритм расчёта даёт результаты как в примерах.
7. **Заказы:** при добавлении товара в заказ стоимость позиции рассчитывается по тем же правилам и корректно влияет на итог заказа.
8. UI отзывчиво пересчитывает суммы при изменении `D` и других параметров.

---

## Допущения (требуют подтверждения)
- Если `D` превышает максимальный `end_day`, для всех оставшихся дней берём цену **последнего уровня**.
- Предупреждения о «возрастающих ценах» между уровнями — не блокирующие.
- При переключениях между режимами значения уровней сохраняются в состоянии формы, но на бэкенд отправляются **только** при `rental_mode='special'`.
