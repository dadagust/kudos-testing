# Интеграция AmoCRM с сервисом аренды мебели

Ниже — предлагаемая схема встраивания AmoCRM в текущий стек (Django REST API + фронтенд витрина и кабинет менеджера). Ориентир: есть публичные REST эндпоинты для заказов (`/api/v1/orders/…`) и клиентов (`/api/v1/customers/…`), которые используют модели `Order`/`OrderItem` и `Customer`/`Company`. Интеграция должна покрывать оба сценария: клиент оформляет аренду самостоятельно либо менеджер заводит заказ вручную через интерфейс.

## Что уже есть в бэкенде

- **Сущности заказов.** `Order` хранит статус, даты монтажа/демонтажа, способ доставки, адрес, комментарий и сумму; строки заказа (`OrderItem`) содержат товар, количество и цены. Встроенный каталог (`PRODUCT_CATALOG`) позволяет высчитывать стоимость. Статусы (`new`, `reserved`, `in_rent`, `in_progress`, `archived`, `cancelled`) пригодны для маппинга на стадии сделки в AmoCRM.【F:applications/orders/models.py†L29-L149】
- **API заказов.** `OrderViewSet` предоставляет полный CRUD: выборка фильтруется по статусам/датам/клиенту и включает связанные позиции; создание/обновление использует `OrderWriteSerializer`, который проверяет адрес доставки, валидирует даты и синхронизирует позиции, пересчитывая итоговую сумму.【F:applications/orders/views.py†L16-L117】【F:applications/orders/serializers.py†L37-L174】
- **Маршруты.** Django `settings/urls.py` публикует ядро и API, а `applications/orders/urls.py` регистрирует ресурс `/api/v1/orders/` через `DefaultRouter`, что позволяет вешать интеграционные хуки вокруг типовых операций списка/создания/обновления/удаления.【F:settings/urls.py†L6-L11】【F:applications/orders/urls.py†L1-L17】
- **Данные о клиентах.** Модель `Customer` хранит тип (физ/юрлицо), ФИО/отображаемое имя, email/телефон с нормализацией, теги и привязку к компании; `Company` содержит реквизиты и контакты для B2B. Эти поля подходят для маппинга на контакт/компанию AmoCRM и для поиска дублей по email/телефону.【F:applications/customers/models.py†L42-L184】

## Ключевые точки интеграции

1. **Создание сделки при новом заказе.** После успешного `POST /api/v1/orders/` (через витрину или кабинет менеджера) отправлять payload в AmoCRM: данные клиента/компании, состав заказа, даты монтажа/демонтажа, способ доставки и комментарий. Источник события — `OrderViewSet.create`.
2. **Синхронизация статусов.** При изменении заказа (`PATCH/PUT /api/v1/orders/{id}/`) синхронизировать статус с воронкой AmoCRM (маппинг статусов `Order.status` → стадии сделки). Можно использовать пост-сохранение в сериализаторе `OrderWriteSerializer.update` или сигнал `post_save` для модели `Order`.
3. **Обновление стоимости и позиций.** Логика `_sync_items` пересчитывает `total_amount` — эту сумму и позиции следует отправлять в AmoCRM как товары/доп. поля, чтобы менеджеры видели актуальный чек.【F:applications/orders/serializers.py†L130-L167】
4. **Связка с контактами/компаниями.** Перед созданием сделки искать/создавать контакт по `email`/`phone_normalized` и при наличии компании — создавать/привязывать сущность компании AmoCRM. Использовать поля из `Customer`/`Company` для заполнения реквизитов и адресов доставки.【F:applications/customers/models.py†L102-L159】【F:applications/orders/models.py†L45-L62】
5. **Двусторонние обновления.** Опционально добавить вебхуки AmoCRM → бекенд для обновления статуса заказа при изменении стадии сделки, чтобы фронты отображали фактическое состояние аренды.

## Техническая реализация (шаги)

1. **Клиент AmoCRM.** Добавить сервисный класс (например, `applications/integrations/amocrm/client.py`) с OAuth2 авторизацией, обновлением токена и методами `create_lead`, `update_lead`, `find_or_create_contact`, `find_or_create_company`, `add_note`, `attach_products`.
2. **Конфигурация.** Завести env-переменные для домена/ID интеграции/секретов/redirect URI и маппинга статусов (например, `AMO_PIPELINE_ID`, `AMO_STATUS_NEW`, `AMO_STATUS_IN_RENT` и т.д.).
3. **События заказов.**
   - Сигналы: подписаться на `post_save`/`post_delete` для `Order` и `OrderItem`, чтобы триггерить синхронизацию. Для мягкого удаления (`perform_destroy` ставит `is_active=False`) посылать статус «отказ/архив».【F:applications/orders/views.py†L112-L114】
   - Альтернатива: обернуть `OrderViewSet.create/update` хуками (например, сервис `OrderSyncService.sync(order, event)`), вызываемыми сразу после `serializer.save()`.
4. **Постановка в очередь.** Обернуть вызовы AmoCRM в Celery/Redis задачи, чтобы не блокировать HTTP-ответы фронта. В задачу передавать `order_id` и тип события (`created`, `updated`, `cancelled`).
5. **Маппинг данных.**
   - Контакт: `first_name/last_name/phone/email/tags`, `company` (для `customer_type=business`).【F:applications/customers/models.py†L102-L159】
   - Сделка: сумма `total_amount`, даты `installation_date`/`dismantle_date`, адрес (`delivery_method` + `delivery_address`), комментарий, связанный контакт/компания, кастомные поля под режим доставки/монтажа.【F:applications/orders/models.py†L41-L62】
   - Товары: конвертация `OrderItem` в товары AmoCRM с количеством и ценой; при обновлении — полная пересборка позиций из `_sync_items`.
6. **Вебхуки из AmoCRM.** Настроить endpoint (например, `core/amocrm/webhook/`) для обработки изменений стадий/оплат. При входящем событии находить заказ по внешнему ID сделки и обновлять `Order.status`, переводя его в `IN_RENT`, `IN_PROGRESS`, `CANCELLED` и т.п.【F:applications/orders/models.py†L29-L36】
7. **Журналирование и отладка.** Записывать результаты синхронизации в audit-лог или отдельную таблицу, чтобы менеджеры видели, была ли сделка/контакт успешно создана.

## Пользовательские сценарии

- **Самостоятельная аренда на витрине.** После `POST /api/v1/orders/` создаётся сделка в AmoCRM, контакт — по данным заказа/клиента, в сделку добавляются товары и сумма; в описании можно писать «источник: сайт». Статус ставится на стадию «Новый/Лид».
- **Ручное оформление менеджером.** При создании/редактировании в кабинете менеджера вызывается та же цепочка; можно добавить опцию «не синхронизировать» (флаг в payload), если требуется черновик без AmoCRM.
- **Изменение статусов.** Менеджер меняет статус заказа — в AmoCRM обновляется стадия; изменение стадии в AmoCRM (по вебхуку) обновляет `Order.status`, чтобы фронт/склады видели актуальные данные.

## Минимальный план внедрения

1. Подготовить клиент AmoCRM + env-настройки и покрыть их тестом на авторизацию.
2. Внедрить сервис синхронизации заказов, подключить к событиям `create/update/delete` и вынести вызовы в Celery.
3. Реализовать маппинг полей/статусов и логирование ошибок синхронизации.
4. Добавить входящий вебхук для стадий сделок и синхронизацию `Order.status`.
5. Провести сквозной тест: создать заказ через витрину, проверить появление сделки, изменить стадию в AmoCRM — увидеть обновление на сайте.
