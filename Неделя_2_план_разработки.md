# План работ: Неделя 2 (kudos.ru)

Цель недели: закрепить архитектуру бекенда, включить аудит изменений данных, ввести ролевые права через миграции для всех типов пользователей из ТЗ и реализовать первый реальный CRUD-срез по сущности «Клиент» (связанной с Компания/Адрес/Контакт) в API.

---

## Календарный план (5 рабочих дней)

### День 1 — Рефакторинг структуры + аудит изменений (audit log)

**Фокус**

- Приведение дерева каталогов бекенда к единому шаблону `apps/` с модульной разбивкой: `accounts`, `customers`, `catalog`, `orders`, `inventory`, `payments`, `logistics`, `documents`, `core` (утилиты, базовые модели, permissions).
- Разделение настроек: `settings/base.py`, `settings/dev.py`, `settings/prod.py`; централизованный `LOGGING` и Sentry-хуки (заглушки).
- Подключение аудита изменений согласно НФ-требованиям ТЗ (audit-log).

**Решение по аудиту**

- Используем табличную историю для моделей через `django-simple-history` **или** эквивалент (пер-модельная история + “кто/когда/что”).
- Базовый `HistoryMixin`: автоматическое сохранение `request.user` (через middleware), IP/UA (по возможности).
- Минимальный охват моделей (на этой неделе): `Customer`, `Company`, `Address`, `Contact`, базовые справочники, если затронем.
- Событийный аудит вне ORM (смены статусов, «жёсткие» операции) — через таблицу `AuditEntry` в `core` и helper для логирования.

---

### День 2 — Роли и права (RBAC) через миграции + тесты

**Фокус**

- Формализация ролей из ТЗ в системные группы/права Django:  
  `Guest`, `Customer`, `B2B`, `SalesManager`, `Warehouse`, `Accountant`, `ContentManager`, `Admin`, `Driver`, `Loader`.
- Датамиграция: создание групп, привязка `auth.Permission` по моделям/действиям.
- Разделение доступа: **витрина (не-staff)** vs **кабинет (staff)**.

## Доступ к кабинетам

- `Guest`, `Customer`, `B2B` → **НЕ staff** (`is_staff=False`) → только витрина/личный профиль/заказы в рамках витрины.
- `SalesManager`, `Warehouse`, `Accountant`, `ContentManager`, `Admin`, `Driver`, `Loader` → **staff** (`is_staff=True`) → полноценный личный кабинет.

> При логине проверяем `is_staff`: если `False` — не пускаем в /admin и staff-UI, редиректим на витрину/403.

## Матрица доступа (MVP этой недели)

| Роль           | Staff (кабинет) | Витрина (каталог/корзина/чекаут) | customers.\* (CRUD)           | companies/addresses/contacts     | orders.\*         | inventory.\*               | documents.\*          | admin |
| -------------- | --------------- | -------------------------------- | ----------------------------- | -------------------------------- | ----------------- | -------------------------- | --------------------- | ----- |
| Guest          | ✗               | ✓ (анон.)                        | –                             | –                                | –                 | R (наличие/цены, публично) | –                     | –     |
| Customer       | ✗               | ✓                                | R/U (только свой профиль)     | R/U (свои адреса)                | R (свои заказы)   | R (наличие/цены, публично) | R (свои счета/чеки)   | –     |
| B2B            | ✗               | ✓                                | R/U (свои/аккаунт компании\*) | R/U (адреса/контакты компании\*) | R (свои/компании) | R (наличие/цены, публично) | R (свои/компании)     | –     |
| SalesManager   | ✓               | ✓                                | CRUD                          | R/U                              | CRUD              | R                          | R                     | –     |
| Warehouse      | ✓               | ✓                                | R                             | R                                | R                 | U (складские статусы)      | R                     | –     |
| Accountant     | ✓               | ✓                                | R                             | R                                | R/U (оплаты)      | –                          | R/U (счета, возвраты) | –     |
| ContentManager | ✓               | ✓                                | –                             | –                                | –                 | –                          | –                     | –     |
| Driver         | ✓               | ✓                                | R (маршруты)                  | –                                | –                 | R (маршруты)               | –                     | –     |
| Loader         | ✓               | ✓                                | R (календарь)                 | –                                | –                 | U (выдача/приёмка)         | –                     | –     |
| Admin          | ✓               | ✓                                | full                          | full                             | full              | full                       | full                  | full  |

\* Для `B2B` — в пределах своей компании (без доступа к staff-интерфейсу).

> Подробная матрица будет расширяться по остальным модулям согласно разделу «Роли и права» из ТЗ.

## Технические пометки для миграций

- Создать группы с именами ролей и привязать `auth.Permission` по моделям/действиям согласно таблице.
- Для `Guest/Customer/B2B` **не назначать** флаги/группы, дающие доступ к staff-UI; гарантировать `is_staff=False`.
- Для staff-ролей при выдаче группы — **обеспечить** `is_staff=True` (через сигнал/команду/админ-политику).
- Тесты:
  - доступ к staff-роутам отклоняется для non-staff;
  - проверки «только свои» (own object) для Customer/B2B;
  - smoke-тесты прав на модели по каждой роли.

---

### Дни 3–5 — API «Клиенты» (Customer/Company/Address/Contact)

**Фокус**

- Реализация публичного REST API для клиентов и связанных сущностей из раздела данных ТЗ: `Customer`, `Company`, `Address`, `Contact`.
- Обновление OpenAPI (v1) + пагинация/фильтры/поиск согласно правилам из ТЗ.

**Объём работ**

1. **Модели и связи**
   - `Customer` ↔ `Company` (опционально, для B2B), `Customer` ↔ `Contact` (много).
   - Поля минимум: ФИО/имя, e-mail, телефон, метки/теги, GDPR/согласия, тип клиента (физ/юр), owner (для scoping «свои» записи). (Сущности и укрупнённая модель — см. ТЗ.)
   - Подключение `HistoryMixin` ко всем перечисленным моделям (см. День 1).

2. **Сериализаторы и валидация**
   - Базовый и детальный сериализаторы (flat + nested для адресов/контактов), нормализация телефона/e-mail, soft-delete (поле `is_active`).
  
3. **Permissions и scoping**
   - DRF-permissions на основе групп из Дня 2 + объектный доступ:
     - `Customer/B2B`: работать только со «своими» клиентскими данными (self/связанные).
     - `SalesManager`: CRUD по всем клиентам.
     - Остальные роли — только чтение или запрет, согласно матрице. (Роли — из ТЗ.)

4. **Эндпоинты (v1)**
   - `GET /api/v1/customer/` — список (пагинация, фильтры: `q`, `email`, `phone`, `tag`, `company_id`, `created__gte/lte`).
   - `POST /api/v1/customer/` — создание (валидация уникальности e-mail/телефона).
   - `GET /api/v1/customer/{id}/` — деталка.
   - `PATCH /api/v1/customer/{id}/` / `PUT` — обновление.
   - `DELETE /api/v1/customer/{id}/` — soft delete.
   - Под-ресурсы (по мере готовности):
     - `GET/POST /api/v1/customer/{id}/contact/`

   - Единый формат ошибок и статусы — как согласовано в ТЗ.

5. **Поиск/фильтры/сортировка**
   - Поиск по `name/email/phone`.
   - Фильтры по компании/тегам/датам.
   - Сортировка `-created`, `name`. (Соглашения из ТЗ.)

6. **OpenAPI и примеры**
   - Обновление `openapi.yaml` (paths, schemas, security).
   - Примеры запросов/ответов (успех, ошибки валидации, 403 по ролям).

7. **Тестирование**
   - API-интеграционные: все CRUD-кейсы + права (200/201/204/403/404).
   - Нагрузочные «smoke» на списки (пагинация 25/50).
   - Проверка записи истории изменений в audit-таблицы при `create/update/delete`.

8. **Страница Деталей Клиента**
   - При клике из списка клиентов должна будет открываться страница деталей

---
